name: CD (self-hosted manual deploy)

on:
    workflow_dispatch:

concurrency:
    group: cd-self-hosted-${{ github.ref }}
    cancel-in-progress: true

jobs:
    deploy:
        runs-on: self-hosted

        env:
            IMAGE_NAME: ${{ vars.IMAGE_NAME }}
            IMAGE_TAG: ${{ vars.IMAGE_TAG }}
            CONTAINER_NAME: ${{ vars.CONTAINER_NAME }}
            HOST_PORT: ${{ vars.HOST_PORT }}

        steps:
            -
                name: Login to Docker Hub (optional for public images)
                uses: docker/login-action@v3
                with:
                    username: ${{ secrets.DOCKERHUB_USERNAME }}
                    password: ${{ secrets.DOCKERHUB_PASSWORD }}

            -
                name: Deploy container (manual)
                shell: pwsh
                run: |
                    $imageName = if ([string]::IsNullOrWhiteSpace($env:IMAGE_NAME)) { "byvoxel/front-iso" } else { $env:IMAGE_NAME }
                    $tag = if ([string]::IsNullOrWhiteSpace($env:IMAGE_TAG)) { "latest" } else { $env:IMAGE_TAG }
                    $image = "$imageName:$tag"

                    $containerName = if ([string]::IsNullOrWhiteSpace($env:CONTAINER_NAME)) { "front-iso" } else { $env:CONTAINER_NAME }
                    $hostPort = if ([string]::IsNullOrWhiteSpace($env:HOST_PORT)) { "8080" } else { $env:HOST_PORT }

                    Write-Host "Pull: $image"
                    docker pull $image

                    docker rm -f $containerName 2>$null
                    docker run -d --restart unless-stopped --name $containerName -p "$hostPort`:80" $image

                    Write-Host "Deploy OK -> http://<self-hosted-host>:$hostPort"
