name: CD (Docker Hub build+push + self-hosted deploy)

on:
    push:
        branches: ["main"]
    workflow_dispatch:

concurrency:
    group: cd-dockerhub-selfhosted-${{ github.ref }}
    cancel-in-progress: true

jobs:
    build-and-push:
        runs-on: ubuntu-latest
        permissions:
            contents: read

        steps:
            - name: Checkout
                uses: actions/checkout@v4

            - name: Set up QEMU
                uses: docker/setup-qemu-action@v3

            - name: Set up Docker Buildx
                uses: docker/setup-buildx-action@v3

            - name: Login to Docker Hub
                uses: docker/login-action@v3
                with:
                    username: ${{ secrets.DOCKERHUB_USERNAME }}
                    password: ${{ secrets.DOCKERHUB_PASSWORD }}

            - name: Docker metadata
                id: meta
                uses: docker/metadata-action@v5
                with:
                    images: byvoxel/front-iso
                    tags: |
                        type=raw,value=latest
                        type=sha,format=short

            - name: Build and push
                uses: docker/build-push-action@v6
                with:
                    context: .
                    push: true
                    platforms: linux/amd64,linux/arm64
                    tags: ${{ steps.meta.outputs.tags }}
                    labels: ${{ steps.meta.outputs.labels }}

    deploy-self-hosted:
        runs-on: self-hosted
        needs: build-and-push
        permissions:
            contents: read

        env:
            IMAGE_NAME: byvoxel/front-iso
            CONTAINER_NAME: ${{ vars.CONTAINER_NAME }}
            HOST_PORT: ${{ vars.HOST_PORT }}

        steps:
            - name: Login to Docker Hub (optional for public images)
                uses: docker/login-action@v3
                with:
                    username: ${{ secrets.DOCKERHUB_USERNAME }}
                    password: ${{ secrets.DOCKERHUB_PASSWORD }}

            - name: Deploy container (Linux)
                if: runner.os != 'Windows'
                shell: bash
                run: |
                    set -euo pipefail

                    sha7="${GITHUB_SHA:0:7}"
                    tag="sha-${sha7}"
                    image="${IMAGE_NAME}:${tag}"

                    containerName="${CONTAINER_NAME:-front-iso}"
                    hostPort="${HOST_PORT:-8080}"

                    echo "Pull: ${image}"
                    docker pull "${image}"

                    echo "Restart container: ${containerName}"
                    docker rm -f "${containerName}" >/dev/null 2>&1 || true

                    docker run -d --restart unless-stopped --name "${containerName}" -p "${hostPort}:80" "${image}"
                    echo "Deploy OK -> http://<self-hosted-host>:${hostPort}"

            - name: Deploy container (Windows)
                if: runner.os == 'Windows'
                shell: powershell
                run: |
                    $sha7 = $env:GITHUB_SHA.Substring(0,7)
                    $tag = "sha-$sha7"
                    $image = "$env:IMAGE_NAME:$tag"

                    $containerName = if ([string]::IsNullOrWhiteSpace($env:CONTAINER_NAME)) { "front-iso" } else { $env:CONTAINER_NAME }
                    $hostPort = if ([string]::IsNullOrWhiteSpace($env:HOST_PORT)) { "8080" } else { $env:HOST_PORT }

                    Write-Host "Pull: $image"
                    docker pull $image

                    docker rm -f $containerName 2>$null
                    docker run -d --restart unless-stopped --name $containerName -p "$hostPort`:80" $image

                    Write-Host "Deploy OK -> http://<self-hosted-host>:$hostPort"
